# 矿工证铭文协议（Draft）

> 来源：`https://github.com/buckyos/usdb/issues/5` 及其讨论评论。
> 状态：草案（Draft），用于统一索引器与产品实现口径。

## 1. 协议目标

- 用单一 `mint` 铭文完成矿工证铸造、激活与能量继承。
- 允许矿工证在 BTC UTXO 模型下可转让，同时避免粉尘攻击和能量双花。
- 支持矿工证绑定主 ETH 地址与协作 ETH 地址，用于后续收益与协作能力扩展。

## 2. 铭文数据格式

所有与矿工证相关的操作均通过 JSON 铭文完成，`op` 固定为 `mint`。

### 2.1 字段定义

| 字段 | 类型 | 必填 | 说明 | 约束 |
| -- | -- | -- | -- | -- |
| `p` | string | 是 | 协议名称 | 固定为 `"usdb"` |
| `op` | string | 是 | 操作类型 | 固定为 `"mint"` |
| `eth_main` | string | 是 | 主 ETH 地址，用于收益接收 | 需为合法 EVM 地址格式 |
| `eth_collab` | string | 否 | 协作 ETH 地址，用于协作/分润扩展 | 为空或合法 EVM 地址 |
| `prev` | string[] | 否 | 继承来源铭文 ID 列表 | 每个元素为有效 Inscription ID |

### 2.2 示例

```json
{
  "p": "usdb",
  "op": "mint",
  "eth_main": "0x1234...NewEthAddr...",
  "eth_collab": "0x5678...CollabAddr...",
  "prev": [
    "old_inscription_id_a",
    "old_inscription_id_b"
  ]
}
```

## 3. 状态模型

矿工证在索引器内维护以下状态：

- `Active`：当前可用于矿工身份与能量结算的铭文。
- `Dormant`：休眠状态（例如发生转移后的原激活铭文）。
- `Consumed`：其能量已被后续铭文继承并原子消耗，不可再次继承。

## 4. 核心规则

### A1. 铸造权即激活权

- 某 BTC 地址 `A` 的当前活跃矿工证，只能是 `A` 自己铸造且最近一次有效的 `mint` 铭文。
- 被动接收（转入）到 `A` 地址的旧铭文不会自动激活。

安全作用：防御粉尘攻击（攻击者无法通过转入铭文劫持激活状态）。

### A2. 转让即休眠

- 任何处于 `Active` 状态的铭文，一旦 UTXO 发生转移，立即变为 `Dormant`。
- 新持有者必须在自己地址重新铸造 `mint`（可引用 `prev`）后才能激活。

安全作用：保证能量所有权变更时显式确认，避免隐式状态漂移。

### A3. 能量原子化消耗

- 当新铭文 `I_new` 引用旧铭文 `I_old`（即 `prev` 包含 `I_old`）时，索引器必须：
  1. 先计算并固化 `I_old` 在引用时点的最终可继承能量；
  2. 将该能量写入 `I_new` 元数据（或等价状态）；
  3. 将 `I_old` 标记为 `Consumed`。

安全作用：防止同一份旧能量被重复继承（Double Spending）。

### A4. 单铭文机制

- 协议采用“单 `mint` + 继承”机制，不再使用 `mint + active` 双铭文。
- 索引器需区分主动铸造与被动持有，并赋予正确初始状态。

## 5. 关键流程

### 5.1 首次激活 / 更新 ETH 地址

1. 用户铸造新 `mint` 铭文 `I_new`，写入新的 `eth_main` / `eth_collab`。
2. 如需继承，`prev` 填入待继承旧铭文 ID。
3. `I_new` 成为该地址当前 `Active` 铭文；被引用旧铭文按规则进入 `Consumed`。

### 5.2 转让与重新激活

1. 地址 `A` 将旧铭文 `I_old` 转移给 `B`，`I_old` 立即进入 `Dormant`。
2. `B` 在自身地址铸造新铭文 `I_new`，并设置 `prev = [I_old]`。
3. `I_new` 激活并继承能量，绑定 `B` 的 ETH 地址。

## 6. 能量计算与继承建议

> 以下为 issue 当前讨论结论与建议，最终参数可在主网前配置化。

- 索引器结算口径：出块与验证流程至少需要“当前目标高度”的矿工证能量。
- 浏览器与审计口径：应支持“给定历史区块高度查询任意矿工证能量”。
- 继承折损：建议默认折损率 `5%`（即继承能量 = 可继承能量 × `0.95`），用于抑制短期投机搬砖。

## 7. 索引器最小校验要求

- 仅处理满足 `p == "usdb" && op == "mint"` 的铭文。
- `eth_main` 必须存在且地址格式合法；`eth_collab` 若存在需合法。
- `prev` 中每个引用必须存在、可访问且未被重复消费。
- 对同一被引用铭文，继承逻辑必须具备事务性或等价原子性保障。
- 状态变更（`Active -> Dormant -> Consumed`）需记录完整日志上下文，便于追溯。

## 8. 待明确事项

- `eth_collab` 的底层收益分配和能量助力算法细节。
- 能量增长函数（与 BTC 余额、持有时长、采样周期的关系）精确公式。
- 是否开放协议版本字段（如 `v`）用于未来兼容升级。
